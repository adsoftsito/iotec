<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Creative - Bootstrap 3 Responsive Admin Template">
    <meta name="author" content="GeeksLabs">
    <meta name="keyword" content="Creative, Dashboard, Admin, Template, Theme, Bootstrap, Responsive, Retina, Minimal">
    <link rel="shortcut icon" href="img/favicon.png">

    <title> Administracion | Usa tu cuenta desde aqui </title>

    <!-- Bootstrap CSS -->    
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap theme -->
    <link href="css/bootstrap-theme.css" rel="stylesheet">
    <!--external css-->
    <!-- font icon -->
    <link href="css/elegant-icons-style.css" rel="stylesheet" />
    <link href="css/font-awesome.min.css" rel="stylesheet" />    
    <!-- Custom styles -->
    <link href="css/style_admin.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet" />

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
      <script src="js/lte-ie7.js"></script>
    <![endif]-->
  </head>

  <body>
  <!-- container section start -->
  <section id="container" class="">

    <!--main content start-->      
    <section id="main-content">
      <section class="wrapper">
    		<div class="row">
    				<div class="col-lg-12">
    					<ol class="breadcrumb">
    						<li><i class="fa fa-home"></i><a href="/">Home</a></li>
    						<li><i class="fa fa-pie-chart"></i>Login</li>
    					</ol>
    				</div>
    			</div>
          <div class="row">
            <div class="col-lg-12">
              <!-- LOGIN -->
              <section class="panel login">
                <header class="panel-heading">Login</header>
                <div class="panel-body">
                  <div class="form-group">
                    <label class="col-sm-2 control-label">Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="name">
                    </div>
                    <div class="form-group">
                      <label class="col-sm-2 control-label">Password</label>
                      <div class="col-sm-10">
                          <input type="password"  class="form-control" placeholder="" id="password">
                      </div>
                    </div>
                      <div class="form-group">
                        <div class="col-lg-offset-2 col-lg-10">
                            <button type="submit" class="btn btn-info btn-block" id="login">Sign in</button>
                        </div>
                      </div>
                  </div>
                </div>
              </section>
              <!-- Crear dispositivo -->
              <section class="panel logged">
                <header class="panel-heading">Create device</header>
                <div class="panel-body">
                  <div class="form-group">
                    <label class="col-sm-2 control-label">Device Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="device-create-name">
                    </div>
                    <div class="form-group">
                      <label class="col-sm-2 control-label">Description</label>
                      <div class="col-sm-10">
                          <input type="text"  class="form-control" placeholder="" id="device-create-description">
                      </div>
                    </div>
                      <div class="form-group">
                        <div class="col-lg-offset-2 col-lg-10">
                            <button type="submit" class="btn btn-success btn-block" id="device-create">Create</button>
                        </div>
                      </div>
                  </div>
                </div>
              </section>
              <!-- Mis dispositivos -->
              <section class="panel logged">
                  <header class="panel-heading">
                      Devices Table
                  </header>
                  
                  <table class="table table-striped table-advance table-hover">
                   <tbody id="devices">
                      <tr>
                         <th> Device name </th>
                         <th> Description </th>
                         <th> ID </th>
                         <th> Actions</th>
                      </tr>
                      <tr id="table-template" hidden="true">
                         <td class="name">Mario Norris</td>
                         <td class="description">Mide el clima de puebla</td>
                         <td class="_id">37123416</td>
                         <td>
                          <div class="btn-group">
                              <a class="btn btn-primary edit-table"><i class="fa fa-pencil"></i></a>
                              <a class="btn btn-danger trash-table"><i class="fa fa-trash"></i></a>
                          </div>
                        </td>
                      </tr>                              
                   </tbody>
                </table>
              </section>
              <!-- Editar dispositivo -->
              <section class="panel logged edit-panel" hidden="true">
                <header class="panel-heading">Edit device</header>
                <div class="panel-body">
                  <div class="form-group">
                    <label class="col-sm-2 control-label">Device Name</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="device-edit-name">
                    </div>
                    <div class="form-group">
                      <label class="col-sm-2 control-label">Description</label>
                      <div class="col-sm-10">
                          <input type="text"  class="form-control" placeholder="" id="device-edit-description">
                      </div>
                    </div>
                      <div class="form-group">
                        <div class="col-lg-offset-2 col-lg-10">
                            <button type="submit" class="btn btn-warning btn-block" id="edit">Save</button>
                        </div>
                      </div>
                  </div>
                </div>
              </section>
            </div>
        </section>
      </section>
    </section>

    <!-- container section end -->
    <!-- javascripts -->
    <script src="js/jquery.js"></script>
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- nice scroll -->
    <script src="js/jquery.scrollTo.min.js"></script>
    <script src="js/jquery.nicescroll.js" type="text/javascript"></script>
    <!-- chartjs -->
    <script src="assets/chart-master/Chart.js"></script>
    <!-- custom chart script for this page only-->
    <script src="js/chartjs-custom.js"></script>
    <!--custome script for all page-->
    <script src="js/scripts.js"></script>
    <script type="text/javascript">
      var token = "";
      var editing = "";
      jQuery.support.cors = true;

      function setDeviceToRow(device, row){
        row.find('.name').html(device.name);
        row.find('.description').html(device.description);
        row.find('._id').html(device._id);
        row.attr('data-id', device._id)
      }

      function goToByScroll(id){
      // Remove "link" from the ID
        id = id.replace("link", "");
          // Scroll
        $('html,body').animate({
            scrollTop: $("#"+id).offset().top},
            'slow');
      }

      function addRowFromDevice(device){
        var row = $('#table-template').clone().removeAttr('id').removeAttr('hidden');
        setDeviceToRow(device, row);
        $('#devices').append(row);
        bindTableButtons();
      }

      function bindTableButtons(){
        $('.edit-table').unbind('click').click(editDeviceStart);
        $('.trash-table').unbind('click').click(deleteDevice);
      }

      function editDeviceStart(){
        var tr = $(this).closest('tr');
        var id = tr.attr('data-id');
        editing = tr;
        $('#device-edit-name').val(tr.find('.name').html());
        $('#device-edit-description').val(tr.find('.description').html());
        $('.edit-panel').css('display', 'block');      
      }

      function deleteDevice(){
        var row = $(this).closest('tr');
        var id = row.attr('data-id');
        row.fadeOut();

        $.post('http://' + window.location.hostname + ":8082/api/device/delete", { id: id, token: token }, function(msg){
            if(msg.success){
              alert( "The device is gone" );
              row.remove();
            }
            else{
              alert(msg.error);
              row.fadeIn();
            }
        }).fail(function(msg){
          console.log(msg)
        });
      }

      $('.logged').css('display', 'none');

      $('#login').click(function(){
        var name = $('#name').val();
        var password = $('#password').val();

        $.post( 'http://' + window.location.hostname + ":8082/api/authenticate", {name: name, password: password}, function( data ) {
          if(data.success){
            token = data.token;
            $('.logged').css('display', 'block');
            $('.login').css('display', 'none');
            $('.edit-panel').css('display', 'none');

            // Obtener datos para la tabla
            $.get('http://' + window.location.hostname + ":8082/api/device", {token: token}, function(data){
              if(!data.success){
                alert("Algo salio mal obteniendo tus dispositivos " + data.error);
              }
              else{
                data.devices.forEach(function(device){
                  addRowFromDevice(device);
                });
              }
            });

          }
          else{
            alert("Parece que tue datos son incorrectos. Por favor corrige" + data.error);
          }
        });
      });

      $('#device-create').click(function(){
        var name = $('#device-create-name').val();
        var description = $('#device-create-description').val();
        $.post('http://' + window.location.hostname + ":8082/api/device", {name: name, desc: description, token: token}, function(data){

          if(!data.success){
            alert("error " + data.error);
          }
          else{
            addRowFromDevice(data.device);
            alert(data.device.name + " creado!")
            $('#device-create-name').val('');
            $('#device-create-description').val('');
          }
        });
      });

      $('#edit').click(function(){
        var name = $('#device-edit-name').val();
        var description = $('#device-edit-description').val();
        $.post('http://' + window.location.hostname + ":8082/api/device/patch", {name: name, desc: description, token: token, id: editing.find('._id').html() }, function(data){

          if(!data.success){
            alert("error " + data.error);
          }
          else{
            setDeviceToRow(data.device, editing);
            alert(data.device.name + " editado!")
            $('.edit-panel').css('display', 'none');      
          }
        });
      });

    </script>
  </body>
</html>
